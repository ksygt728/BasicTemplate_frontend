pipeline {
  agent any

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  environment {
    REPO_URL    = 'https://github.com/ksygt728/BasicTemplate_frontend.git'
    IMAGE_NAME  = 'cbms-front'
    DEPLOY_PATH = '/srv/docker'
  }

  stages {

    stage('Init Params') {
      steps {
        echo "================ Jenkins Build Parameters ================"
        echo "ENV           : ${params.ENV}"
        echo "BRANCH        : ${params.BRANCH}"
        echo "DEPLOY_SERVER : ${params.DEPLOY_SERVER}"
        echo "=========================================================="
      }
    }

    stage('Checkout') {
      steps {
        git branch: params.BRANCH,
            credentialsId: 'git-credential',
            url: env.REPO_URL
      }
    }

    stage('Prepare Tag') {
      steps {
        script {
          def tz = TimeZone.getTimeZone('Asia/Seoul')
          def dateStr = new Date().format('yyyy-MM-dd_HH', tz)

          env.TAG = "front-${params.ENV}-${dateStr}-${env.BUILD_NUMBER}"

          echo "▶ Build ENV        : ${params.ENV}"
          echo "▶ Build Number     : ${env.BUILD_NUMBER}"
          echo "▶ Generated TAG    : ${env.TAG}"
        }
      }
    }

    stage('Docker Build') {
      steps {
        sh """
          cd frontend/cbms
          docker build -t ${IMAGE_NAME}:${TAG} .
        """
      }
    }

    stage('Deploy') {
      steps {
        sshagent(credentials: ['deploy-key']) {
          sh """
            ssh deploy@${params.DEPLOY_SERVER} '
              cd ${DEPLOY_PATH}
              IMAGE_TAG=${TAG} ENV=${params.ENV} \
              docker compose -f docker-compose.front.yml up -d
            '
          """
        }
      }
    }

    stage('Git Tag') {
      steps {
        sshagent(credentials: ['git-ssh-key']) {
          sh """
            git tag -a ${TAG} -m "front deploy ${params.ENV}"
            git push origin ${TAG}
          """
        }
      }
    }
  }
}