pipeline {
  agent any

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  parameters {
    choice(name: 'ENV', choices: ['dev', 'qa', 'prod'])
    string(name: 'BRANCH', defaultValue: 'main')
  }

  environment {
    // ✅ HTTPS + PAT 사용
    REPO_URL   = 'https://github.com/ksygt728/BasicTemplate_frontend.git'
    IMAGE_NAME = 'cbms-front'
    DEPLOY_PATH = '/srv/docker'
  }

  stages {

    stage('Checkout') {
      steps {
        git branch: params.BRANCH,
            credentialsId: 'git-credential', // Jenkins Credential ID를 입력해야함
            url: env.REPO_URL
      }
    }

    stage('Prepare Tag') {
      steps {
        script {
          env.TAG = "front-${params.ENV}-${env.BUILD_NUMBER}"
        }
      }
    }

    stage('Docker Build') {
      steps {
        sh """
          docker build -t ${IMAGE_NAME}:${TAG} .
        """
      }
    }

    stage('Deploy') {
      steps {
        sshagent(credentials: ['deploy-key']) {
          sh """
            ssh deploy@${params.ENV}-server '
              cd ${DEPLOY_PATH}
              IMAGE_TAG=${TAG} ENV=${params.ENV} \
              docker compose -f docker-compose.front.yml up -d
            '
          """
        }
      }
    }

    // ⚠️ Git tag / push는 SSH로만 안전하게
    stage('Git Tag') {
      steps {
        sshagent(credentials: ['git-ssh-key']) {
          sh """
            git tag -a ${TAG} -m "front deploy ${params.ENV}"
            git push origin ${TAG}
          """
        }
      }
    }
  }
}